<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAw-AhqKS1FemISwb7JdyldSb_ESp1FQhA",
    authDomain: "smart-travel-planner-bd849.firebaseapp.com",
    projectId: "smart-travel-planner-bd849",
    storageBucket: "smart-travel-planner-bd849.appspot.com",
    messagingSenderId: "1017075766889",
    appId: "1:1017075766889:web:6c7c7d3440c3aac45db4f8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    if (user) currentUser = user;
    else window.location.href = "index.html";
  });

  const form = document.getElementById("tripForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const overlay = document.getElementById("loadingOverlay");
    overlay.style.display = "flex";

    const origin = document.getElementById("origin").value;
    const destination = document.getElementById("destination").value;
    const date = document.getElementById("date").value;
    const days = document.getElementById("days").value;
    const travelers = document.getElementById("travelers").value;
    const budget = document.getElementById("budget").value;

    try {
      if (!currentUser) throw new Error("User not logged in.");

      // ✅ FIXED: correct Firestore collection path to match result.html
      await addDoc(collection(db, "users", "public", "trips"), {
        origin, destination, date, days, travelers, budget,
        createdAt: new Date().toISOString()
      });

      // ✅ Backend route (Render)
      const res = await fetch("https://smart-travel-planner-68vq.onrender.com/trip/plan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ origin, destination, date, days, travelers, budget })
      });

      const data = await res.json();
      sessionStorage.setItem("tripData", JSON.stringify(data));
      window.location.href = "result.html";

    } catch (err) {
      alert("Error: " + err.message);
      console.error(err);
    } finally {
      overlay.style.display = "none";
    }
  });
</script>
