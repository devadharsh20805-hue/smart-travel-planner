<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trip Result - Smart Travel Planner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Roboto:wght@400;700&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(to bottom, #a8e6ff, #f0faff);
  display: flex;
  height: 100vh;
  overflow-y: scroll;
  scrollbar-width: none;
}
body::-webkit-scrollbar { display: none; }
</style>
</head>
<body>

<!-- Floating icons -->
<img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" class="floating" alt="plane">
<img src="https://cdn-icons-png.flaticon.com/512/414/414927.png" class="floating" alt="cloud">
<img src="https://cdn-icons-png.flaticon.com/512/616/616490.png" class="floating" alt="luggage">
<img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" class="floating" alt="plane">
<img src="https://cdn-icons-png.flaticon.com/512/414/414927.png" class="floating" alt="cloud">

<!-- Sidebar -->
<div class="sidebar">
  <div>
    <h1>Smart Travel Planner</h1>
    <div class="menu">
      <button onclick="window.location.href='home.html'">ğŸ  Explore</button>
      <button onclick="window.location.href='trip.html'">ğŸ§­ Plan a Trip</button>
      <button onclick="window.location.href='mytrips.html'">ğŸ§³ My Trips</button>
      <button onclick="window.location.href='profile.html'">ğŸ‘¤ Profile</button>
    </div>
  </div>
  <div class="menu">
    <button onclick="window.location.href='index.html'">ğŸšª Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <div class="container">
    <h2>Your Trip Plan ğŸ˜‰</h2>
    <div id="tripDetails"></div>

    <div id="itinerary">
      <h3>Itinerary:</h3>
      <ul id="itineraryList"></ul>
    </div>

    <h3>Map of Your Itinerary:</h3>
    <div id="map"></div>

    <button class="primary" id="saveTripBtn">ğŸ’¾ Save Trip</button>
    <button class="primary" onclick="window.location.href='trip.html'">Plan Another Trip</button>
  </div>
</div>

<!-- âœ… Firebase Integration -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAw-AhqKS1FemISwb7JdyldSb_ESp1FQhA",
  authDomain: "smart-travel-planner-bd849.firebaseapp.com",
  projectId: "smart-travel-planner-bd849",
  storageBucket: "smart-travel-planner-bd849.appspot.com",
  messagingSenderId: "1017075766889",
  appId: "1:1017075766889:web:6c7c7d3440c3aac45db4f8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tripDetails = document.getElementById('tripDetails');
const itineraryList = document.getElementById('itineraryList');
let latestTrip = null;
window.latestTrip = null; // âœ… make global for map

// ğŸ§­ Fetch latest trip for this logged-in user
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const tripsRef = collection(db, "users", user.uid, "trips");
    const querySnapshot = await getDocs(tripsRef);

    if (querySnapshot.empty) {
      tripDetails.innerHTML = "<p>No trip data found. Please plan a trip first.</p>";
      return;
    }

    const allTrips = [];
    querySnapshot.forEach(doc => allTrips.push(doc.data()));
    latestTrip = allTrips.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt))[0];
    window.latestTrip = latestTrip;

    const safeValue = (val) => val ? val : "N/A";
    tripDetails.innerHTML = `
      <p><strong>Origin:</strong> ${safeValue(latestTrip.origin)}</p>
      <p><strong>Destination:</strong> ${safeValue(latestTrip.destination)}</p>
      <p><strong>Date:</strong> ${safeValue(latestTrip.date)}</p>
      <p><strong>Days:</strong> ${safeValue(latestTrip.days)}</p>
      <p><strong>Travelers:</strong> ${safeValue(latestTrip.travelers)}</p>
      <p><strong>Budget:</strong> â‚¹${latestTrip.budget ? Number(latestTrip.budget).toLocaleString() : "N/A"}</p>
    `;

    for (let i=1; i<=latestTrip.days; i++) {
      itineraryList.innerHTML += `<li><strong>Day ${i}:</strong> Explore top places in ${latestTrip.destination}</li>`;
    }

    if (window.initMap && typeof window.initMap === "function") {
      window.initMap();
    }
  } catch (err) {
    console.error("Error loading trip:", err);
    tripDetails.innerHTML = "<p>Error loading trip details.</p>";
  }
});

document.getElementById("saveTripBtn").addEventListener("click", () => {
  alert("âœ… Trip already saved to Firebase when planned!");
});
</script>

<!-- âœ… Map route + markers -->
<script>
window.initMap = function() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 6,
    center: { lat: 20.5937, lng: 78.9629 },
  });

  const checkTrip = setInterval(() => {
    if (!window.latestTrip?.origin || !window.latestTrip?.destination) return;
    clearInterval(checkTrip);

    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer({
      map: map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: "#007bff",
        strokeWeight: 5,
      },
    });

    const request = {
      origin: window.latestTrip.origin,
      destination: window.latestTrip.destination,
      travelMode: google.maps.TravelMode.DRIVING,
    };

    directionsService.route(request, (result, status) => {
      if (status === google.maps.DirectionsStatus.OK) {
        directionsRenderer.setDirections(result);
      } else {
        console.error("Directions failed:", status);
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: window.latestTrip.destination }, (results, s) => {
          if (s === "OK" && results[0]) {
            map.setCenter(results[0].geometry.location);
            new google.maps.Marker({
              map,
              position: results[0].geometry.location,
              title: window.latestTrip.destination,
            });
          }
        });
      }
    });
  }, 800);
};
</script>

<!-- âœ… Async Google Maps -->
<script
  async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgnTn2jnHUN8bTJkFkDm05ginAbAG9urU&libraries=places&callback=initMap">
</script>
</body>
</html>
