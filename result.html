<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trip Result - Smart Travel Planner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Roboto:wght@400;700&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(to bottom, #a8e6ff, #f0faff);
  display: flex;
  min-height: 100vh;
  overflow-y: auto;
}
body::-webkit-scrollbar { display: none; }

.sidebar {
  width: 250px;
  background: white;
  padding: 20px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar h1 {
  font-family: 'Dancing Script', cursive;
  color: #0077b6;
  text-align: center;
  margin-bottom: 30px;
}
.sidebar .menu button {
  display: block;
  width: 100%;
  margin: 8px 0;
  padding: 10px;
  border: none;
  border-radius: 10px;
  background: #caf0f8;
  font-size: 16px;
  cursor: pointer;
  transition: 0.3s;
}
.sidebar .menu button:hover {
  background: #0077b6;
  color: white;
}

.main-content {
  flex: 1;
  padding: 20px;
}
.container {
  max-width: 900px;
  margin: auto;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}
h2, h3 { color: #0077b6; margin-bottom: 15px; }
#tripDetails p { margin-bottom: 10px; }
#itineraryList li { margin-bottom: 8px; }

#map { height: 400px; width: 100%; margin: 20px 0; }

button.primary {
  background: #0077b6;
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  margin-right: 10px;
  cursor: pointer;
}
button.primary:hover { background: #023e8a; }
</style>
</head>
<body>

<div class="sidebar">
  <div>
    <h1>Smart Travel Planner</h1>
    <div class="menu">
      <button onclick="window.location.href='home.html'">üè† Explore</button>
      <button onclick="window.location.href='trip.html'">üß≠ Plan a Trip</button>
      <button onclick="window.location.href='mytrips.html'">üß≥ My Trips</button>
      <button onclick="window.location.href='profile.html'">üë§ Profile</button>
    </div>
  </div>
  <div class="menu">
    <button onclick="window.location.href='index.html'">üö™ Logout</button>
  </div>
</div>

<div class="main-content">
  <div class="container">
    <h2>Your Trip Plan üòâ</h2>
    <div id="tripDetails"></div>

    <div id="itinerary">
      <h3>Itinerary:</h3>
      <ul id="itineraryList"></ul>
    </div>

    <h3>Map of Your Itinerary:</h3>
    <div id="map"></div>

    <button class="primary" id="saveTripBtn">üíæ Save Trip</button>
    <button class="primary" onclick="window.location.href='trip.html'">Plan Another Trip</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAw-AhqKS1FemISwb7JdyldSb_ESp1FQhA",
  authDomain: "smart-travel-planner-bd849.firebaseapp.com",
  projectId: "smart-travel-planner-bd849",
  storageBucket: "smart-travel-planner-bd849.appspot.com",
  messagingSenderId: "1017075766889",
  appId: "1:1017075766889:web:6c7c7d3440c3aac45db4f8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tripDetails = document.getElementById('tripDetails');
const itineraryList = document.getElementById('itineraryList');

let latestTrip = null;

// ------------------ Map ------------------
window.initMap = function() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 6,
    center: { lat: 20.5937, lng: 78.9629 }, // default India center
  });

  if (!latestTrip?.origin || !latestTrip?.destination) return;

  const directionsService = new google.maps.DirectionsService();
  const directionsRenderer = new google.maps.DirectionsRenderer({
    map: map,
    suppressMarkers: false,
    polylineOptions: { strokeColor: "#007bff", strokeWeight: 5 }
  });

  const request = {
    origin: latestTrip.origin,
    destination: latestTrip.destination,
    travelMode: google.maps.TravelMode.DRIVING
  };

  directionsService.route(request, (result, status) => {
    if (status === "OK") directionsRenderer.setDirections(result);
    else {
      console.error("Directions failed:", status);
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: latestTrip.destination }, (results, s) => {
        if (s === "OK" && results[0]) {
          map.setCenter(results[0].geometry.location);
          new google.maps.Marker({ map, position: results[0].geometry.location, title: latestTrip.destination });
        }
      });
    }
  });
};

// ------------------ Load Trip from Firebase ------------------
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const tripsRef = collection(db, "users", user.uid, "trips");
    const querySnapshot = await getDocs(tripsRef);

    if (querySnapshot.empty) {
      tripDetails.innerHTML = "<p>No trip data found. Please plan a trip first.</p>";
      return;
    }

    const allTrips = [];
    querySnapshot.forEach(doc => allTrips.push(doc.data()));
    latestTrip = allTrips.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

    const safeValue = val => val || "N/A";
    tripDetails.innerHTML = `
      <p><strong>Origin:</strong> ${safeValue(latestTrip.origin)}</p>
      <p><strong>Destination:</strong> ${safeValue(latestTrip.destination)}</p>
      <p><strong>Date:</strong> ${safeValue(latestTrip.date)}</p>
      <p><strong>Days:</strong> ${safeValue(latestTrip.days)}</p>
      <p><strong>Travelers:</strong> ${safeValue(latestTrip.travelers)}</p>
      <p><strong>Budget:</strong> ‚Çπ${latestTrip.budget ? Number(latestTrip.budget).toLocaleString() : "N/A"}</p>
    `;

    itineraryList.innerHTML = "";
    for (let i=1; i<=Number(latestTrip.days); i++) {
      itineraryList.innerHTML += `<li><strong>Day ${i}:</strong> Explore top places in ${latestTrip.destination}</li>`;
    }

    // Initialize Map after data is loaded
    window.initMap();

  } catch(err) {
    console.error("Error loading trip:", err);
    tripDetails.innerHTML = "<p>Error loading trip details.</p>";
  }
});

document.getElementById("saveTripBtn").addEventListener("click", () => {
  alert("‚úÖ Trip already saved to Firebase when planned!");
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgnTn2jnHUN8bTJkFkDm05ginAbAG9urU&libraries=places&callback=initMap"></script>
</body>
</html>
