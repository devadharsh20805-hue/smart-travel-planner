<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trip Result - Smart Travel Planner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Roboto:wght@400;700&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
Â  font-family: 'Roboto', sans-serif;
Â  background: linear-gradient(to bottom, #a8e6ff, #f0faff);
Â  display: flex;
Â  min-height: 100vh;
Â  overflow-y: auto;
}
body::-webkit-scrollbar { display: none; }

.sidebar {
Â  width: 250px;
Â  background: white;
Â  padding: 20px;
Â  display: flex;
Â  flex-direction: column;
Â  justify-content: space-between;
Â  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar h1 {
Â  font-family: 'Dancing Script', cursive;
Â  color: #0077b6;
Â  text-align: center;
Â  margin-bottom: 30px;
}
.sidebar .menu button {
Â  display: block;
Â  width: 100%;
Â  margin: 8px 0;
Â  padding: 10px;
Â  border: none;
Â  border-radius: 10px;
Â  background: #caf0f8;
Â  font-size: 16px;
Â  cursor: pointer;
Â  transition: 0.3s;
}
.sidebar .menu button:hover {
Â  background: #0077b6;
Â  color: white;
}

.main-content {
Â  flex: 1;
Â  padding: 20px;
}
.container {
Â  max-width: 900px;
Â  margin: auto;
Â  background: white;
Â  border-radius: 20px;
Â  padding: 30px;
Â  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}
h2, h3 { color: #0077b6; margin-bottom: 15px; }
#tripDetails p { margin-bottom: 10px; }
#itineraryList li { margin-bottom: 8px; }
/* Added styling for nested itinerary list */
#itineraryList ul {
  margin-left: 20px;
  margin-top: 5px;
}

#map { height: 400px; width: 100%; margin: 20px 0; }

button.primary {
Â  background: #0077b6;
Â  color: white;
Â  border: none;
Â  padding: 12px 20px;
Â  border-radius: 10px;
Â  margin-right: 10px;
Â  cursor: pointer;
}
button.primary:hover { background: #023e8a; }
</style>
</head>
<body>

<div class="sidebar">
Â  <div>
Â  Â  <h1>Smart Travel Planner</h1>
Â  Â  <div class="menu">
Â  Â  Â  <button onclick="window.location.href='home.html'">ğŸ  Explore</button>
Â  Â  Â  <button onclick="window.location.href='trip.html'">ğŸ§­ Plan a Trip</button>
Â  Â  Â  <button onclick="window.location.href='mytrips.html'">ğŸ§³ My Trips</button>
Â  Â  Â  <button onclick="window.location.href='profile.html'">ğŸ‘¤ Profile</button>
Â  Â  </div>
Â  </div>
Â  <div class="menu">
Â  Â  <button onclick="window.location.href='index.html'">ğŸšª Logout</button>
Â  </div>
</div>

<div class="main-content">
Â  <div class="container">
Â  Â  <h2>Your Trip Plan ğŸ˜‰</h2>
Â  Â  <div id="tripDetails"></div>

Â  Â  <div id="itinerary">
Â  Â  Â  <h3>Itinerary:</h3>
Â  Â  Â  <ul id="itineraryList"></ul>
Â  Â  </div>

    Â  Â  <h3>Map of Your Trip:</h3>
Â  Â  <div id="map"></div>

Â  Â  <button class="primary" id="saveTripBtn">ğŸ’¾ Save Trip</button>
Â  Â  <button class="primary" onclick="window.location.href='trip.html'">Plan Another Trip</button>
Â  </div>
</div>

<script>
  window.initMap = function() {
    // Placeholder function. The module script will overwrite this.
  };
</script>

<script type="module">
// Import 'query', 'orderBy', and 'limit' for a more efficient Firebase query
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
Â  apiKey: "AIzaSyAw-AhqKS1FemISwb7JdyldSb_ESp1FQhA",
Â  authDomain: "smart-travel-planner-bd849.firebaseapp.com",
Â  projectId: "smart-travel-planner-bd849",
Â  storageBucket: "smart-travel-planner-bd849.appspot.com",
Â  messagingSenderId: "1017075766889",
Â  appId: "1:1017075766889:web:6c7c7d3440c3aac45db4f8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tripDetails = document.getElementById('tripDetails');
const itineraryList = document.getElementById('itineraryList');

let latestTrip = null; // This will be set by the data loader

// ------------------ Map ------------------
// This function definition overwrites the placeholder
window.initMap = function() {
Â  const map = new google.maps.Map(document.getElementById("map"), {
Â  Â  zoom: 6,
Â  Â  center: { lat: 20.5937, lng: 78.9629 }, // default India center
Â  });

  // Only proceed if trip data has been loaded
Â  if (!latestTrip?.origin || !latestTrip?.destination) return;

Â  const directionsService = new google.maps.DirectionsService();
Â  const directionsRenderer = new google.maps.DirectionsRenderer({
Â  Â  map: map,
Â  Â  suppressMarkers: false,
Â  Â  polylineOptions: { strokeColor: "#007bff", strokeWeight: 5 }
Â  });

Â  const request = {
Â  Â  origin: latestTrip.origin,
Â  Â  destination: latestTrip.destination,
Â  Â  travelMode: google.maps.TravelMode.DRIVING
Â  };

Â  directionsService.route(request, (result, status) => {
Â  Â  if (status === "OK") directionsRenderer.setDirections(result);
Â  Â  else {
Â  Â  Â  console.error("Directions failed:", status);
Â  Â  Â  const geocoder = new google.maps.Geocoder();
Â  Â  Â  geocoder.geocode({ address: latestTrip.destination }, (results, s) => {
Â  Â  Â  Â  if (s === "OK" && results[0]) {
Â  Â  Â  Â  Â  map.setCenter(results[0].geometry.location);
Â  Â  Â  Â  Â  new google.maps.Marker({ map, position: results[0].geometry.location, title: latestTrip.destination });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  });
};

// ------------------ Data Display Function ------------------
/**
 * Populates the HTML with data from a trip object.
 * Handles both full AI-generated objects and basic Firebase input objects.
 */
function displayTripData(trip) {
    latestTrip = trip; // Set the global variable for the map
    const safeValue = val => val || "N/A";
    
    // Check if we have the full AI-generated object (it will have 'estimatedBudget')
    const isFullTrip = trip.hasOwnProperty('estimatedBudget');
    
    // FIX #1: Safely convert budget values to strings, preventing toLocaleString error
    const displayBudget = trip.budget ? Number(trip.budget).toLocaleString() : "N/A";
    const displayEstimatedBudget = trip.estimatedBudget ? Number(trip.estimatedBudget).toLocaleString() : "N/A";

    tripDetails.innerHTML = `
Â  Â  Â  <p><strong>Origin:</strong> ${safeValue(trip.origin)}</p>
Â  Â  Â  <p><strong>Destination:</strong> ${safeValue(trip.destination)}</p>
Â  Â  Â  <p><strong>Date:</strong> ${safeValue(trip.date)}</p>
Â  Â  Â  <p><strong>Days:</strong> ${safeValue(trip.days)}</p>
Â  Â  Â  <p><strong>Travelers:</strong> ${safeValue(trip.travelers)}</p>
Â  Â  Â  <p><strong>Your Budget:</strong> â‚¹${displayBudget}</p>
    `;

    // Add AI-specific details only if they exist
    if (isFullTrip) {
        tripDetails.innerHTML += `
            <p><strong>Estimated Trip Cost:</strong> â‚¹${displayEstimatedBudget} (${safeValue(trip.budgetMatch)})</p>
            <p><strong>Travel Time:</strong> ${safeValue(trip.travelDuration)}</p>
            <p><strong>Weather:</strong> ${safeValue(trip.weather)}</p>
        `;
    }

Â  Â  itineraryList.innerHTML = "";
    
    // Display detailed itinerary if it exists
    if (isFullTrip && trip.itinerary && Array.isArray(trip.itinerary)) {
        trip.itinerary.forEach(dayPlan => {
            itineraryList.innerHTML += `
                <li>
                    <strong>Day ${dayPlan.day}:</strong>
                    <ul>
                        <li><small>Morning:</small> ${safeValue(dayPlan.morning)}</li>
                        <li><small>Afternoon:</small> ${safeValue(dayPlan.afternoon)}</li>
                        <li><small>Evening:</small> ${safeValue(dayPlan.evening)}</li>
                    </ul>
                </li>
            `;
        });
    } else {
        // Fallback for basic data (or if AI fails to return itinerary)
        const numDays = Number(trip.days) || 1;
        for (let i = 1; i <= numDays; i++) {
Â  Â  Â        itineraryList.innerHTML += `<li><strong>Day ${i}:</strong> Explore top places in ${safeValue(trip.destination)}</li>`;
Â  Â      }
    }
    
    // Now that 'latestTrip' is set, initialize the map
    window.initMap();
}

// ------------------ Load Trip Data ------------------
/**
 * Loads trip data, prioritizing sessionStorage (for new plans)
 * and falling back to Firebase (for refreshes/direct loads).
 */
function loadTrip() {
    // FIX #1: Prioritize loading the full AI-generated trip from sessionStorage
    const storedTripData = sessionStorage.getItem("tripData");

    if (storedTripData) {
        try {
            const trip = JSON.parse(storedTripData);
            displayTripData(trip);
            sessionStorage.removeItem("tripData"); // Clear it after use
            return; // We are done
        } catch (err) {
            console.error("Failed to parse trip data from session storage:", err);
            // If parsing fails, fall through to load from Firebase
        }
    }

    // Fallback: If no sessionStorage data, load latest trip input from Firebase
    onAuthStateChanged(auth, async (user) => {
    Â  if (!user) {
    Â  Â  window.location.href = "index.html";
    Â  Â  return;
    Â  }

    Â  try {
        // More efficient query: Get only the single latest trip
    Â  Â  const tripsRef = collection(db, "users", user.uid, "trips");
        const q = query(tripsRef, orderBy("createdAt", "desc"), limit(1));
    Â  Â  const querySnapshot = await getDocs(q);

    Â  Â  if (querySnapshot.empty) {
    Â  Â  Â  tripDetails.innerHTML = "<p>No trip data found. Please plan a trip first.</p>";
    Â  Â  Â  return;
    Â  Â  }

        // Get the single latest document
    Â  Â  const latestTripData = querySnapshot.docs[0].data();
        displayTripData(latestTripData);

    Â  } catch(err) {
    Â  Â  console.error("Error loading trip from Firebase:", err);
    Â  Â  tripDetails.innerHTML = "<p>Error loading trip details.</p>";
    Â  }
    });
}

// Start the data loading process
loadTrip();


document.getElementById("saveTripBtn").addEventListener("click", () => {
Â  alert("âœ… Trip already saved to Firebase when planned!");
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgnTn2jnHUN8bTJkFkDm05ginAbAG9urU&libraries=places&callback=initMap"></script>
</body>
</html>
